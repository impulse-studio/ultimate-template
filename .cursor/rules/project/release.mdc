---
description: Manual workflow_dispatch release tags dev and syncs main
globs: .github/workflows/release.yml, .github/scripts/bump-version.mjs, package.json
alwaysApply: false
---
priority: high
version: 2025.11.22
---

# Manual Release Workflow

## Intent
- Provide a single workflow_dispatch entry point to cut releases from `dev` while keeping `main` aligned.
- Guarantee every release tag matches the root `package.json` version and includes autogenerated notes.
- Capture how version increments and branch mirroring work so contributors follow the same pipeline.

## Checklist
- Run `Manual Release` via workflow_dispatch and choose `patch`, `minor`, or `major`. Default is `patch`.
- Let `.github/scripts/bump-version.mjs` apply the semver bump to the root `package.json`. Do not edit versions manually.
- Keep commits clean: the workflow commits `chore: release vX.Y.Z`, tags `vX.Y.Z`, and pushes to `dev`.
- Allow the workflow to push `HEAD:main --force-with-lease` so `main` always matches the freshly released dev state.
- Rely on the workflow’s release step to publish GitHub release notes. Avoid creating releases by hand.

## Details
### Workflow Trigger
- `.github/workflows/release.yml` is exclusively `workflow_dispatch`. It checks out `dev` with full history so it can tag and compare correctly.
- The `release_type` input drives the semver bump. Requests without an explicit choice are treated as `patch`.

### Version Management
- `.github/scripts/bump-version.mjs` reads the root `package.json`, computes the next semver using the chosen release type, writes the new version, and prints it for later steps.
- The script enforces numeric `major.minor.patch` versions. If parsing fails the workflow stops before committing.
- The root package is initialized with `0.0.0`; every workflow run advances it, so tags and package metadata stay synchronized.

### Tagging, Releases, and Branch Sync
- After the commit, the workflow creates the tag `v<version>` and pushes it alongside `dev`.
- Releases are published with `ncipollo/release-action@v1` and `generateReleaseNotes: true`, so notes mirror GitHub’s compare view automatically.
- The final push uses `git push origin HEAD:main --force-with-lease`, effectively fast-forwarding `main` to the new release commit while aborting if `main` moved unexpectedly.

### Example Run
```
Manual Release input: patch
Result: commit + tag v0.0.1 on dev, push dev, push HEAD:main --force-with-lease, create release v0.0.1 with autogenerated notes.
```
