---
description: Centralize environment validation under @repo/env and enforce client/server usage
globs: package.json, apps/web/**/*.ts, apps/web/**/*.tsx, packages/server/**/*.ts, packages/database/**/*.ts, packages/env/**/*.ts, apps/web/next.config.js
alwaysApply: false
---
priority: high
version: 2025.11.21
---

# Shared Env Package

## Intent
- Ensure every environment variable flows through the shared `@repo/env` schemas so server and client code receive validated, typed values.
- Eliminate ad-hoc `process.env` access and duplicate dotenv loading so secrets and public values stay consistent across packages.

## Checklist
- Depend on `@repo/env` (server) or `@repo/env/client` (browser-only modules) before referencing any environment variable.
- Import `{ env }` inside server contexts (Next.js routes, `packages/server`, `packages/database`) and `{ clientEnv }` inside client-only modules.
- Keep `@repo/env` listed under `transpilePackages` in `apps/web/next.config.js`.
- Update both `packages/env/src/server.ts` and `packages/env/src/client.ts` plus `packages/env/src/resolved-values.ts` whenever new keys are introduced.

## Details
### Server modules
- Call `env` for secrets such as `DATABASE_URL`, `RESEND_FROM_EMAIL`, and `REDIS_URL`. Never touch `process.env` directly; validation already occurs in `packages/env/src/load-env.ts`.
- Re-export derived `NEXT_PUBLIC_*` values from the server schema so SSR and edge handlers stay aligned with the browser bundle.

### Client modules
- Import `{ clientEnv }` from `@repo/env/client` for feature flags and public URLs like `NEXT_PUBLIC_REACT_QUERY_DEVTOOLS` or `NEXT_PUBLIC_API_URL`.
- Only invoke `clientEnv` from files that run exclusively in the browser to avoid leaking undefined shims into the server build.

### Next.js configuration
- `apps/web/next.config.js` must transpile `@repo/env` because the package ships TypeScript. Remove any redundant `dotenv` logic from Next.js config; `packages/env` loads `.env` once.

### Schema changes
- When adding a variable, declare it in the relevant Zod schema (`server.ts` or `client.ts`), mirror any required defaults inside `resolved-values.ts`, and re-export from the package index.
- Run `pnpm precommit` after updating schemas to catch type or lint regressions early.

## Examples
### ✅ Server usage
```ts
import { env } from "@repo/env";

const pool = new Pool({
  connectionString: env.DATABASE_URL,
});
```
Rely on the validated connection string instead of duplicating parsing logic.

### ❌ Direct process access
```ts
const apiBase = process.env.NEXT_PUBLIC_API_URL ?? "http://localhost:3000";
```
Bypasses the shared validator, skips defaults, and risks mismatched client/server values.
